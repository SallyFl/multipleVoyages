<html>
<head>
    <title>test multiple voyages</title>
    <script src="https://d3js.org/d3.v4.min.js"></script>
    <script src="https://d3js.org/topojson.v0.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.3.1.min.js"></script>
    <link href="css/bootstrap.min.css" rel="stylesheet" media="screen">

    <link href="https://fonts.googleapis.com/css?family=IBM+Plex+Serif" rel="stylesheet">

    <style>

    svg {
    display: block;
    margin: auto;
    background-color: #D2DCE7;
    }
  }

  .placeVisited {
  fill: #999;
  }
  .journey {
  fill: none;
  stroke-width: 3;
  }

  #dataTitle{
    font-family: 'IBM Plex Serif', serif;
    font-size: 20px;
    fill: #6E6E6E;
  }

  /*#animateMap {*/
  .buttonGroup{
    position: relative;
    background:  #6E6E6E;
    -webkit-border-radius: 2;
    -moz-border-radius: 2;
    border-radius: 2px;
    font-family: 'IBM Plex Serif', serif;
    color: #ffffff;
    font-size: 15px;
    text-decoration: none;
    margin-bottom: 10px;
  }

  /*#animateMap:hover {*/
  .buttonGroup:hover{
    background: orange;
    text-decoration: none;
  }

</style>
</head>

<body>

  <div class ="map"></div>

<script>


var width = 1300;
var height = 500;

 var margin ={top: 10, right: 10,bottom: 50, left:10}

 var svg = d3.select("body")
    .append("svg")
    .attr("width", width + margin.left + margin.right)
    .attr("height", height + margin.top + margin.bottom)

  var projection = d3.geoMercator()
    .center([30, 12])
    .scale(220)
    .translate([width / 2, height / 2])

  var geoPath = d3.geoPath()
    .projection(projection);

  var voyageLine = d3.line()
    .x(function(d) {return projection([d.lon, d.lat])[0];})
    .y(function(d) {return projection([d.lon, d.lat])[1];})
    .curve(d3.curveCatmullRom);

  var color = d3.scaleOrdinal(d3.schemeCategory10);

  d3.queue()
    .defer(d3.json, "data/world110m.json")
    .defer(d3.csv, "data/multipleVoyages3.csv")
    .await(ready);

function ready (error, oceans, data){
  //function ready (error, data){ // testing only without map

    var dataGroup = d3.nest()
      .key(function(d) {return d.year;})
      .key(function(d){return d.VoyageID;})
      .entries(data);

dataGroup.forEach(function(yearObject,i) {
    yearObject.values.forEach(function(voyageObject, voyageIndex) {
        voyageObject.values.forEach(function(dataObject, dataIndex) {


var ocean = svg.selectAll( "path" )
  .data(topojson.object(oceans, oceans.objects.countries)
  .geometries)
    .enter()
    .append( "path" )
    .attr("fill", "white")
    .attr( "d", geoPath );

var buttonGroups = d3.selectAll("button")
    .data(dataGroup)
    .enter()
    .append("button")
    .attr("class", "buttonGroup")
    .attr("data-group", function(d){return d.key})
    .attr("id", function(d){return "button_" + d.key})
    .append("label")
    .text(function(d){return d.key;})

var voyageGroups = svg.selectAll(".voyageGroup")
  .data(dataGroup)
  .enter()
  .append("g")
  .attr("class", function(d){return "voyageGroup voyage_" + d.key})
  .attr("data-group", function(d){return d.key})
  .attr("id", function(d){return "group_" + d.key})
  .style("opacity", 0.2)

var paths = voyageGroups.selectAll(".journey")
    .data(function(d){return d.values})
    .enter()
    .append("path")
    .attr("d", function(d){
		  return voyageLine(d.values)
		})
		.attr("class", "journey")
    .attr("id", function(d){
    return "path_" + d.key
  })
  .attr("stroke", function(d){ return color(d.key)})

var voyageMarker = voyageGroups.selectAll(".voyageMarker")
   .data(function(d){ return d.values})
   .enter()
   .append("circle")
   .attr("class", "voyageMarker")
   .attr("id", function(d){
     return "marker_" + d.key
   })
   .attr("r", 10)
   .style("fill", "red")
  .attr("transform", "translate(-100,-100)");
  // .attr("transform", "translate(0,0)"); // puts circle in top left corner

var textGroups = voyageGroups.selectAll(".dateText")
  .data(function(d){ return d.values})
  .enter()
  .append("text")
  .attr("class", "dateText")
  .attr("x", 20)
  .attr("y", 60)
  .attr("id", function(d){return "dataTitle_" + d.key})

var placeGroups = voyageGroups.selectAll(".placeVisited")
    .data(function(d) {return d.values;})
    .enter()
    .append("g")
    .attr("class", "placeVisited")
    .attr("fill", function(d) {return d.color = color(d.key);})
    .attr("id", function(d){return "place_" + d.key });
    /*Add mouse event tooltips to get details of places visited etc*/

 var placeVisited = placeGroups.selectAll("placeVisited")
   .data(function(d) {return d.values;})
   .enter()
   .append("circle")
   .attr("cx", function(d, i) {
     return projection([d.lon, d.lat])[0];
   })
   .attr("cy", function(d, i) {
     return projection([d.lon, d.lat])[1];

   })
   .attr("r", 5)
   .style("stroke","transparent")
   .style("stroke-width","15px")


 var textGroups = voyageGroups.selectAll(".dateText")
   .data(function(d){ return d.values})
   .enter()
   .append("g")
   .attr("class", "dateText")
   .attr("id", function(d){return "dataTitle_" + d.key})


   var dateText = textGroups.selectAll("dateText")
   .data(function(d){ return d.values})
   .enter()
   .append("text")
   //.text ("")
   .text(function(d,i) { return d.arrivalDateTxt; })
   .attr("x", 20)
   .attr("y", 60);

//buttons
d3.select("#button_1961").on("click", function(d){
  tryAgain(d,i);
  clickButton(d,i);
});
d3.select("#button_1906").on("click", function(d){
  tryAgain(d,i);
  clickButton(d,i);
});
d3.select("#button_1845").on("click", function(d){
  tryAgain(d,i);
  clickButton(d,i);
});
d3.select("#button_1888").on("click", function(d){
  tryAgain(d,i);
  clickButton(d,i);
});


var animation;
var isAnimating = false

function tryAgain(d,i){
if(isAnimating){
  clearInterval(animation)
  d3.select("#dataTitle_"+ voyageID)
  textGroups.text.exit().remove();
}
else{
var voyageID = d.values[0].key;
console.log(voyageID);



var j = 0;
var animation = setInterval(function(){
d3.select("#dataTitle_"+ voyageID)
    .text(function(d) { return d.values[j].arrivalDateTxt; });
    j = j + 1;
    if(j==d.values[0].values.length)
      clearInterval(animation)
    },1000);
  }
  isAnimating = !isAnimating;
}


function clickButton(d,i) {
  var voyageClass = d.key;
  //console.log(voyageClass);
  var voyageID = d.values[0].key; // gives 1,2,3 on click
  //console.log(voyageID);

d3.select(".voyage_" + voyageClass).style("opacity", 1.0)

d3.select("circle#Marker_"+ voyageID)
  .transition()
  .ease(d3.easeLinear)
  .duration(5000)
  .attrTween("transform", createPathTween);

d3.select("#path_" + voyageID)
  .attr("stroke-dasharray", function() {
    var totalLength = this.getTotalLength();
    return totalLength + " " + totalLength;
  })
  .attr("stroke-dashoffset", function() {
    var totalLength = this.getTotalLength();
    return totalLength;
  })
  .transition()
  .ease(d3.easeLinear)
  .duration(5000)
  .attr("stroke-dashoffset", 0)

}

function createPathTween(d, i, a) {

    var id = d.key;

    var path = document.getElementById("path_" + id)
    //console.log(path);
    var l = path.getTotalLength();

    return function(t) {
      var p = path.getPointAtLength(t * l);
      return "translate(" + p.x + "," + p.y + ")";
    };
  }

});
});

});
}

</script>
</body>

</html>

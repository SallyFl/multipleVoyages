<html lang="en">
<head>

<meta charset="utf-8">
    <title>Life on ocean waves</title>
    <script src="https://d3js.org/d3.v4.min.js"></script>
    <script src="https://d3js.org/topojson.v0.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.3.1.min.js"></script>
    <link href="css/bootstrap.min.css" rel="stylesheet" media="screen">

    <link href="https://fonts.googleapis.com/css?family=IBM+Plex+Serif" rel="stylesheet">

    <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <style>

  body {
    font-family: 'IBM Plex Serif', serif;
    color:#6E6E6E;
  }

  svg {
  display: block;
  margin: auto;
  background-color: #EAECEE  ;
  }

img{
  border-radius: 3px;
  width:90%;
}

.journey {
  fill: none;
  stroke-width: 2;
  }
.place{
  opacity: 0.5;
}
.place:hover{
  fill: #00FF40;
  r:10;
}
.dateText{
  font-size: 20px;
  fill: #6E6E6E;
  }

.buttons{
  position: relative;
  background:  #6E6E6E;
  -webkit-border-radius: 2;
  -moz-border-radius: 2;
  border-radius: 2px;
  color: #ffffff;
  font-size: 15px;
  text-decoration: none;
  margin-bottom: 10px;
}

.buttons:hover{
  background: orange;
  text-decoration: none;
}

.buttons:focus{
  background: orange;;
}

.tooltip {
  width:auto;
  height:50px;
  padding: 3px;
  opacity:0;
}

.tooltip.hidden {
  display: none;
}


#header{
    background-color: orange;
    color: #ffffff;
    width:100%;
    margin-left:15px;
    margin-right: 15px;
    padding: 10px;
}
#map
  {
    position: relative;
    display: inline-block;
    width:100%;
    margin-left:15px;
    margin-right: 15px;
  }

#voyageDesc
  {
    position: absolute;
    right: 0;
    top: 0;
    width:25%;
    height: 200px;
  }
  #voyageDesc p{
    width:90%;
  }

#mapdata
  {
    position: absolute;
    /*right: 0;*/
    left: 0;
    top: 0;
    width:25%;
    height: 200px;
  }

  #buttons {
    width:100%;
    height:80px;
    margin-left:15px;
    margin-right: 15px;
  }

  @media only screen and (max-width: 600px) and (orientation:portrait){

h1{
  font-size: 28px;
}

h3{
  font-size: 24px;
}

#header{
    background-color: orange;
    color: #ffffff;
    width:100%;
    margin-left:15px;
    margin-right: 15px;
    padding: 5px;
}
  #map
    {
      position: absolute;
      width:100%;
      height: 600px;
      margin-left:15px;
      margin-right: 15px;
    }

  #voyageDesc{
      width:100%;
      height: 250px;
      position:relative;
      top:20px;
    }

    #voyageDesc p{
      width:90%;
    }

  #mapdata{
      width:100%;
      height: 250px;
      position:absolute;
      right:0;
      top:0;

    }

  #buttons {
      width:100%;
      height:40px;
      margin-left:15px;
      margin-right: 15px;
      position:relative;
      top:150px; /* was 150*/
    }

    .place:hover{
    r:20;
    }
}

@media only screen and (max-width: 600px) and (orientation:landscape){
h1{
  font-size: 28px;
}

h3{
  font-size: 24px;
}

#header{
    background-color: orange;
    color: #ffffff;
    width:100%;
    margin-left:15px;
    margin-right: 15px;
    padding: 5px;
}
#map
  {
    position: absolute;
    width:100%;
    height: 300px;
    margin-left:15px;
    margin-right: 15px;
  }

#voyageDesc{
    width:50%;
    /*height: 250px;*/

    position:relative;
    top:20px;
  }

  #voyageDesc p{
    width:90%;
  }

#mapdata{
    width:100%;
    height: 250px;
    position:absolute;
    right:0;
    top:0;

  }

#buttons {
    width:100%;
    height:40px;
    margin-left:15px;
    margin-right: 15px;
    position:relative;
    top:150px;
  }

  .place:hover{
  r:20;
  }
}
</style>
</head>

<body>
<div id ="container">

  <div id ="header">
    <h1>Life on the ocean waves</h1>
  </div>

  <div id = "map">
    <div id ="svg"></div>
    <div id ="mapdata"></div>
    <div id = "voyageDesc"></div>
  </div>

  <div id = "buttons"></div>

</div>
<script>

var mapWidth = $("#map").width(),
    width = 1300,
    height = 500; // was 500


var svg = d3.select("#svg").append("svg")
    .attr("preserveAspectRatio", "xMidYMid")
    .attr("viewBox", "0 0 " + width + " " + height)
    .attr("width", mapWidth)
    .attr("height", mapWidth * height / width);

var projection = d3.geoMercator()
    .center([0, 8 ])
    .scale(180)
    .rotate([-150,0])
    .translate([width / 2, height / 2])

var geoPath = d3.geoPath()
  .projection(projection);

var voyageLine = d3.line()
  .x(function(d) {return projection([d.lon, d.lat])[0];})
  .y(function(d) {return projection([d.lon, d.lat])[1];})
  .curve(d3.curveCatmullRom);


var color = d3.scaleOrdinal()
  .range(["#084B8A", "#FE642E" , "#FE2EC8","#81BEF7"]);


//tooltip for mouseover
var tooltip = d3.select("body").append("div")
    .attr("class", "tooltip")

var description = d3.select("body").append("div")
      .attr("class", "description")


d3.queue()
  .defer(d3.json, "data/world110m.json")
  //.defer(d3.csv, "data/voyageData.csv")
 .defer(d3.csv, "data/multipleVoyages.csv")
  .await(ready);

function ready (error, oceans, data){
//function ready (error, data){ // testing only without map


var dataGroup = d3.nest()
      .key(function(d) {return d.year;}).sortKeys(d3.ascending)
      .key(function(d){return d.voyageID;}).sortKeys(d3.ascending)
      .entries(data);

dataGroup.forEach(function(d,i) {

var ocean = svg.selectAll( "path" )

.data(topojson.object(oceans, oceans.objects.countries)
.geometries)
  .enter()
  .append( "path" )
  .attr("fill", "white")
  .attr( "d", geoPath );

var buttons = d3.select("#buttons").selectAll("button")
    .data(dataGroup)
    .enter()
    .append("button")
    .attr("class", function(d){return "buttons voyage_" + d.key})
    .attr("datagroup", function(d){return d.key})
    .attr("id", function(d){return "button_" + d.key})
    .append("label")
    .text(function(d){return d.key;})

var voyageData = d3.select("#map").select("#mapdata").selectAll(".voyageData")
    .data(dataGroup)
    .enter()
    .append("div")
    .attr("class", "voyageData")
    .attr("data-group", function(d){return d.key})
    .attr("id", function(d){return "voyageText_" + d.key})

var data = voyageData.selectAll(".data")
    .data(function(d) {return d.values;})
    .enter()
    .append("div")
    .attr("class", "data")
    .attr("id", function(d){return "data_" + d.key})

var voyageDesc = d3.select("#map").select("#voyageDesc").selectAll(".voyageDesc")
    .data(dataGroup)
    .enter()
    .append("div")
    .attr("class", "voyageDesc")
    .attr("data-group", function(d){return d.key})
    .attr("id", function(d){return "voyageDesc_" + d.key})

var desc = voyageDesc.selectAll(".desc")
    .data(function(d) {return d.values;})
    .enter()
    .append("div")
    .attr("class", "data")
    .attr("id", function(d){return "desc_" + d.key})

var images = voyageDesc.selectAll(".images")
    images.data(function(d) {return d.values;})
    .enter()
    .append("div")
    .attr("class", "images")
    .attr("id", function(d){return "images_" + d.key})

var voyageGroups = svg.selectAll(".voyageGroup")
    .data(dataGroup)
    .enter()
    .append("g")
    .attr("class", function(d){return "voyageGroup voyage_" + d.key})
    .attr("datagroup", function(d){return d.key})
    .attr("id", function(d){return "group_" + d.key})
    .style("opacity", 0.3)


var paths = voyageGroups.selectAll(".journey")
    .data(function(d){return d.values})
    .enter()
    .append("path")
    .attr("d", function(d){return voyageLine(d.values)})
		.attr("class", "journey")
    .attr("id", function(d){return "path_" + d.key})
    .attr("fill", "none")
    .attr("stroke", function(d){ return color(d.key)})
    .attr("opacity",0)
    .on("mouseover", function(d,i) {
      d3.select(this)
        .style("opacity", 1)
      })

var voyageMarker = voyageGroups.selectAll(".voyageMarker")
   .data(function(d){ return d.values})
   .enter()
   .append("circle")
   .attr("class", "voyageMarker")
   .attr("id", function(d){
     return "marker_" + d.key
   })
   .attr("r", 9)
   .style("fill", function(d){ return color(d.key)})
   .attr("transform", "translate(-100,-100)");
  // .attr("transform", "translate(0,0)"); // puts circle in top left corner

var placeGroups = voyageGroups.selectAll(".placeVisited")
    .data(function(d) {return d.values;})
    .enter()
    .append("g")
    .attr("class", "placeVisited")
    .attr("fill", function(d) {return d.color = color(d.key);})
    .attr("id", function(d){return "place_" + d.key});

var placeVisited = placeGroups.selectAll("placeVisited")
   .data(function(d) {return d.values;})
   .enter()
   .append("circle")
   .attr("class","place")
   .attr("cx", function(d, i) {
     return projection([d.lon, d.lat])[0];
   })
   .attr("cy", function(d, i) {
     return projection([d.lon, d.lat])[1];

   })
   .attr("r", 5)
   .style("stroke","transparent")
   .style("stroke-width","15px")

   .on("mouseover", function(d) {
     tooltip.transition()
         .duration(200)
         .style("opacity", 1)
     tooltip.html( d.placeName + "<br/>"+ d.arrivalDate + "</p>")
         .style('left',(d3.event.pageX + 10) + 'px')
         .style('top', (d3.event.pageY + 10) + 'px')

         d3.select(".tooltip").classed("hidden", false);
     })
    .on("mouseout", function(d){
        d3.select(".tooltip").classed("hidden", true);
        d3.select(this).attr("r",5)
    })

  //button - click to start animation
  buttons.on("click", clickButton);

  var runningAnimation = null;

  function stopAnimation(animation, voyageID) {
    clearInterval(animation);

    d3.select("#data_"+ voyageID).text("");
    d3.select("#mapdata").style("opacity", 0);
    d3.select("#path_" + voyageID).style("opacity", 0);
    d3.select("#placeVisited_" + voyageID).style("opacity", 0);
  //  d3.select("#group_" + voyageClass).style("opacity", 0)
    runningAnimation = null;
  }


function clickButton(d,i) {

  var voyageClass = d.key;
  var voyageID = d.values[0].key;

 if (runningAnimation) { stopAnimation(runningAnimation.animation, runningAnimation.voyageID); }

  //animate place name and dates
    var j = 0;
    var animation = setInterval(function(){

    d3.select("#mapdata").style("opacity", 1);

    d3.select("#data_"+ voyageID)
     .html(function(d) { return "<h3>" + d.values[j].voyageType + "</h3><p><span style ='font-size: 14px; font-weight:bold;'>" + d.values[j].arrivalDate + "<br/>" + d.values[j].placeName; + "</span></p>"});

      j = j + 1;

      if(j==d.values[0].values.length) { stopAnimation(animation, voyageID); }
      },1000);

      runningAnimation = { animation: animation, voyageID: voyageID };

//style voyage line and circles
    d3.select(".voyage_" + voyageClass).style("opacity", 1.0)

    //animate circle marker
    d3.select("circle#Marker_"+ voyageID)
      .transition()
      .ease(d3.easeLinear)
      .duration(9500)
      .attrTween("transform", createPathTween);

    //animate voyage path line
    d3.select("#path_" + voyageID)
      .attr("stroke-dasharray", function() {
        var totalLength = this.getTotalLength();
        return totalLength + " " + totalLength;
      })
      .attr("stroke-dashoffset", function() {
        var totalLength = this.getTotalLength();
        return totalLength;
      })
      .transition()
      .ease(d3.easeLinear)
      .duration(9500)
      .attr("stroke-dashoffset", 0)
      .attr("opacity",1)
    }

//mouse over buttons to get voyage data and image
buttons.on("mouseover", mouseover);
var runningchange = null;

function stopchange(change, voyageID) {

  d3.select("#desc_"+ voyageID).text("");
  d3.select("#images_" + voyageID).select("img").remove();
  runningchange = null;
}

function mouseover(d,i) {

  if (runningchange) { stopchange(runningchange.change, runningchange.voyageID); }

  var voyageClass = d.key;
  var voyageID = d.values[0].key;

  d3.select("#button_" + voyageClass).style("background-color", function(d){ return color(voyageID)})
  d3.select("#group_" + voyageClass).style("opacity", 1) // maybe get rid of this?

  var j = 0;

  var change = (function(){

    j = j + 1;

    if(j==d.values[0].values.length) { stopchange(change, voyageID); }
    });

    runningchange = { change: change, voyageID: voyageID };


    d3.select("#desc_"+ voyageID)
      .html(function(d) { return "<h3>" + d.values[j].voyageType + "</h3><p><span style ='color:hotpink;font-size: 18px; font-weight:bold;'>" + d.values[j].period +"</span><br/><span style ='color:orange;font-size: 18px; font-weight:bold;'>" + d.values[j].voyageName + "</span></p><br/>" +"<p>" + d.values[j].voyageDesc; + "</p>"});

    d3.select("#images_" + voyageID)
        .append("a")
        .attr("href", function(d){return d.values[j].groupURL })
        .append("img")
        .attr("src", function(d){return "images/" +d.values[j].groupPic });
}


//animate all voyages on opening page
function transition(){
   voyageMarker.transition()
   .ease(d3.easeLinear)
   .duration(9500)
   .attrTween("transform", createPathTween)

   paths.transition()
   .attr("stroke-dasharray", function() {
     var totalLength = this.getTotalLength();
     return totalLength + " " + totalLength;
   })
   .attr("stroke-dashoffset", function() {
     var totalLength = this.getTotalLength();
     return totalLength;
   })
   .transition()
   .ease(d3.easeLinear)
   .duration(9500)
   .attr("stroke-dashoffset", 0)
  // .on("end", transition);
}

transition();

function createPathTween(d, i, a) {

    var id = d.key;
    var path = document.getElementById("path_" + id)
    var l = path.getTotalLength();

    return function(t) {
      var p = path.getPointAtLength(t * l);
      return "translate(" + p.x + "," + p.y + ")";
      };
    }
  });

}

//resize
$(window).resize(function() {
  var w = $("#map").width();
  svg.attr("width", w);
  svg.attr("height", w * height / width);

  });


  </script>
  </body>

  </html>

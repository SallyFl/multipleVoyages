<html>
<head>
    <title>working version</title>
	<script src="https://d3js.org/d3.v4.min.js"></script>
	<script src="https://d3js.org/topojson.v0.min.js"></script>
	<script src="https://code.jquery.com/jquery-3.3.1.min.js"></script>
	<link href="css/bootstrap.min.css" rel="stylesheet" media="screen">
    <style>

    svg {
    display: block;
    margin: auto;
    background-color: #D2DCE7;
    }
  }

  .placeVisited {
  fill: #999;
  }
  .journey {
  fill: none;
  stroke-width: 3;
  }


#tooltip {
  color: #6E6E6E;
  position:absolute;
  width:200px;
  height: auto;
  padding: 10px;
  background-color: white;
  -webkit-box-shadow: 4px 4px 10px rgba(0, 0, 0, 0.4);
  -moz-box-shadow: 4px 4px 10px rgba(0, 0, 0, 0.4);
  box-shadow: 4px 4px 10px rgba(0, 0, 0, 0.4);
}

#tooltip.hidden {
  display: none;
}

#tooltip p {
  margin: 0;
  font-size: 16px;
  line-height: 20px;
}

</style>
</head>

<body>
  <h1>Life on the ocean waves</h1>

  <div id="tooltip">
  <a href="http://collections.anmm.gov.au" id ="link"><img src="images/00038301_1.jpg" id="pic" width="150"></a>

    <p><span id="voyageName"></span></p>
    <p><span id="period"></span></p>
    <p><span id="description"></span></p>

  </div>


<script>
var width = 1300;
var height = 500;

 var margin ={top: 10, right: 10,bottom: 50, left:10}

 var svg = d3.select("body")
    .append("svg")
    .attr("width", width + margin.left + margin.right)
    .attr("height", height + margin.top + margin.bottom)

  var projection = d3.geoMercator()
    .center([30, 12])
    .scale(220)
    .translate([width / 2, height / 2])

  var geoPath = d3.geoPath()
    .projection(projection);

  var voyageLine = d3.line()
    .x(function(d) {return projection([d.lon, d.lat])[0];})
    .y(function(d) {return projection([d.lon, d.lat])[1];})
    .curve(d3.curveCatmullRom);

  var parseDate = d3.timeParse("%d %B %Y");
  var parseYear = d3.timeParse("%Y");
  var formatYear = d3.timeFormat("%Y");

  var color = d3.scaleOrdinal(d3.schemeCategory10);


  d3.queue()
  .defer(d3.json, "data/world110m.json")
  .defer(d3.csv, "data/multipleVoyages.csv")
  .await(ready);

function ready (error, oceans, data){
  //function ready (error, data){ // testing data only - no map data

    data.forEach(function(d) { // do I even need this forEach
      d.year = formatYear(parseYear(+d.year));
      d.lon = +d.lon;
      d.lat = +d.lat;
});

    var dataGroup = d3.nest()
      .key(function(d) {return d.year;})
      .key(function(d){return d.VoyageID;})
      .entries(data);


dataGroup.forEach(function(d,i) {

 
//map can be commented out to make looking at elements easier
var ocean = svg.selectAll( "path" )
  .data(topojson.object(oceans, oceans.objects.countries)
  .geometries)
    .enter()
    .append( "path" )
    .attr("fill", "white")
    .attr( "d", geoPath );

var buttonGroups = d3.selectAll("button")
    .data(dataGroup)
    .enter()
    .append("button")
    //.attr("class", function(d){
     //return "buttonGroup voyage_" + d.key
    //})
    .attr("class", "buttonGroup")
    .attr("data-group", function(d){return d.key})
    .attr("id", function(d){return "button_" + d.key})
    .append("label")
    .text(function(d){return d.key;})

var button = buttonGroups.selectAll("p")
    .data(function(d){return d.values})
    .enter()
    .append("p")
    .attr("data-group", function(d){
    return  d.key
  })


var voyageGroups = svg.selectAll(".voyageGroup")
    .data(dataGroup)
    .enter()
    .append("g")
    //.attr("class", function(d){return "voyage_" + d.key}) // gives odd structure
   .attr("class", function(d){return "voyageGroup voyage_" + d.key}) // need two classes here I think - first to give correct structure and second so I can interact with this element with buttons
    //.attr("class", "voyageGroup")
    .attr("data-group", function(d){return d.key})
    .attr("id", function(d){return "group_" + d.key})
    .style("opacity", 0.2)


var paths = voyageGroups.selectAll(".journey")
    .data(function(d){return d.values})
    .enter()
    .append("path")
    .attr("d", function(d){
		  return voyageLine(d.values)
		})
		.attr("class", "journey")
    .attr("id", function(d){
    return "path_" + d.key
  })
    .attr("stroke", function(d){ return color(d.key)})

  var voyageMarker = voyageGroups.selectAll(".voyageMarker")
     .data(function(d){ return d.values})
     .enter()
     .append("circle")
     .attr("class", "voyageMarker")
     .attr("id", function(d){
       return "marker_" + d.key
     })
     .attr("r", 10)
     .style("fill", "red")
    .attr("transform", "translate(-100,-100)"); // try to put this at beginning of each path
    // .attr("transform", "translate(0,0)"); // puts circle in top left corner

   var placeGroups = voyageGroups.selectAll(".placeVisited")
     .data(function(d) {return d.values;})
     .enter()
     .append("g")
     .attr("class", "placeVisited")
      .attr("fill", function(d) {return d.color = color(d.key);})
     .attr("id", function(d){
       return "place_" + d.key
       });

   var placeVisited = placeGroups.selectAll("placeVisited")
     .data(function(d) {return d.values;})
     .enter()
     .append("circle")
     .attr("cx", function(d, i) {
       return projection([d.lon, d.lat])[0];

     })
     .attr("cy", function(d, i) {
       return projection([d.lon, d.lat])[1];

     })
     .attr("r", 5)

     .style("stroke","transparent")
     .style("stroke-width","15px")

     .on("mouseover", function(d) {
       d3.select(this)
           .transition()
           .duration(50)
           .style("fill", function(d) {
             if(d.url !== null && d.url  !== '')
             {return "#FE642E" //orange if url exists
             }else {return "#A4A4A4"} ;})
           .attr("r", "7");

    //Update the tooltip image and data
           d3.select("#tooltip")
           .select("#link")
           .attr("href", d.groupURL);

           d3.select("#period")
           .text(d.period);

           d3.select("#voyageName")
           .text(d.groupName);

           d3.select("#description")
           .text(d.description);

           d3.select("#pic")
           .attr("src","images/"+d.groupPic);

     //Use default image in tooltip if no image in data set
     d3.select("#pic").on("error", function(){
       let el = d3.select(this);
       el.attr("src", "images/ANMS1249[017].jpg")
       el.on("error", null);
     })

     //Show the tooltip
    // d3.select("#tooltip").classed("hidden", false);

 })
/*
 .on("mouseout", function() {
       d3.select(this)
         .transition()
         .delay(100)
         .duration(1000)
*/
 //Hide the tooltip - comment out for now so image remains in tool tip in div
// d3.select("#tooltip").classed("hidden", true);
 //})
//

//buttons
d3.select("#button_1961").on("click", clickPrint);
d3.select("#button_1906").on("click", clickPrint);
d3.select("#button_1845").on("click", clickPrint);


// button callback function
function clickPrint(d) {

    var voyageClass = d3.select(this).attr("data-group");
    var voyageID = d3.select(this).select("p").attr("data-group");

     // would like help in getting all ids,  e.g. #path_3 and #path_4 from one data-group, e.g. 1845, so each marker and line can transition if button is clicked. In code below where I have hard coded the markers and paths for 1845 this works fine but there could be more individual voyages in a year group so would like to do this from the data
    //console.log(voyageID);

    d3.select(".voyage_" + voyageClass).style("opacity", 1.0)

    d3.select("circle#Marker_"+ voyageID)
      .transition()
      .ease(d3.easeLinear)
      .duration(5000)
      .attrTween("transform", createPathTween);

    d3.select("#path_" + voyageID)
      .attr("stroke-dasharray", function() {
        var totalLength = this.getTotalLength();
        return totalLength + " " + totalLength;
      })
      .attr("stroke-dashoffset", function() {
        var totalLength = this.getTotalLength();
        return totalLength;
      })
      .transition()
      .ease(d3.easeLinear)
      .duration(5000)
      .attr("stroke-dashoffset", 0)

}
/*
d3.select('#button_1961').on('click', function(d) {

d3.select(".voyage_1961").style("opacity", 1.0)

d3.select("#path_2")
  .attr("stroke-dasharray", function() {
    var totalLength = this.getTotalLength();
    return totalLength + " " + totalLength;
  })
  .attr("stroke-dashoffset", function() {
    var totalLength = this.getTotalLength();
    return totalLength;
  })
  .transition()
  .ease(d3.easeLinear)
  .duration(5000)
  .attr("stroke-dashoffset", 0)

d3.select("circle#Marker_2")
  .transition()
  .ease(d3.easeLinear)
  .duration(5000)
  .attrTween("transform", createPathTween);
  })

*/
//buttons
/*
d3.select('#button_1906').on('click', function(d) {

d3.select(".voyage_1906").style("opacity", 1.0)

d3.select("#path_1")
  .attr("stroke-dasharray", function() {
    var totalLength = this.getTotalLength();
    return totalLength + " " + totalLength;
  })
  .attr("stroke-dashoffset", function() {
    var totalLength = this.getTotalLength();
    return totalLength;
  })
  .transition()
  .ease(d3.easeLinear)
  .duration(5000)
  .attr("stroke-dashoffset", 0)

d3.select("circle#Marker_1")
  .transition()
  .ease(d3.easeLinear)
  .duration(5000)
  .attrTween("transform", createPathTween);
  })

d3.select('#button_1961').on('click', function(d) {
  d3.select(".voyage_1961").style("opacity", 1.0)

  d3.select("#path_2")
    .attr("stroke-dasharray", function() {
      var totalLength = this.getTotalLength();
      return totalLength + " " + totalLength;
    })
    .attr("stroke-dashoffset", function() {
      var totalLength = this.getTotalLength();
      return totalLength;
    })
    .transition()
    .ease(d3.easeLinear)
    .duration(5000)
    .attr("stroke-dashoffset", 0)

  d3.select("circle#Marker_2")
.transition()
   .ease(d3.easeLinear)
   .duration(5000)
   .attrTween("transform", createPathTween)
    })

//here i can set both markers and lines in transition on one click as both ids are referenced here, ie #path_3 and #path_4
d3.select('#button_1845').on('click', function(d) {
  d3.select(".voyage_1845").style("opacity", 1.0)

  d3.select("#path_3")
    .attr("stroke-dasharray", function() {
      var totalLength = this.getTotalLength();
      return totalLength + " " + totalLength;
    })
    .attr("stroke-dashoffset", function() {
      var totalLength = this.getTotalLength();
      return totalLength;
    })
    .transition()
    .ease(d3.easeLinear)
    .duration(5000)
    .attr("stroke-dashoffset", 0)

  d3.select("circle#Marker_3")
    .transition()
    .ease(d3.easeLinear)
    .duration(5000)
    .attrTween("transform", createPathTween)

    d3.select("#path_4")
      .attr("stroke-dasharray", function() {
        var totalLength = this.getTotalLength();
        return totalLength + " " + totalLength;
      })
      .attr("stroke-dashoffset", function() {
        var totalLength = this.getTotalLength();
        return totalLength;
      })
      .transition()
      .ease(d3.easeLinear)
      .duration(5000)
      .attr("stroke-dashoffset", 0)

  d3.select("circle#Marker_4")
    .transition()
    .ease(d3.easeLinear)
    .duration(5000)
    .attrTween("transform", createPathTween);
      })
    //})

*/


/*
//think this is defunct now - was transitioning everything at once but now using buttons to select groups
  function transition(){
      voyageMarker.transition()//var
       .ease(d3.easeLinear)
       .duration(5000)
       .attrTween("transform", createPathTween)

       paths.transition()
       .attr("stroke-dasharray", function() {
         var totalLength = this.getTotalLength();
         return totalLength + " " + totalLength;
       })
       .attr("stroke-dashoffset", function() {
       var totalLength = this.getTotalLength();
      return totalLength;
       })
       .transition()
       .ease(d3.easeLinear)
       .duration(5000)
       .attr("stroke-dashoffset", 0)
      //.on("end", transition);
  }
*/
//transition();

//animate voyageMarker
  function createPathTween(d, i, a) {

    var id = d.key;
    var path = document.getElementById("path_" + id)
    var l = path.getTotalLength();

    return function(t) {
      var p = path.getPointAtLength(t * l);
      return "translate(" + p.x + "," + p.y + ")";
      };
    }
})

}

</script>
</body>

</html>
